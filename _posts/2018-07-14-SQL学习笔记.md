---
layout:     post
title:      Introduction to MySQL Syntax
subtitle:   SQL学习笔记——以Dognition公司为例
date:       2018-07-14
author:     ZF
header-img: img/post-bg-ios9-web.jpg
catalog: true
tags:
    - SQL
    - Runtime
--- 
![](http://m.qpic.cn/psb?/V12j1VvP2SOs2p/dOe6ehq9qk6XSWJWpUtwhW3jY2SH2JwzWQzf7TRYubs!/b/dAgBAAAAAAAA&bo=dAQ4BAAAAAARF2w!&rf=viewer_4)
而在当下几TB的数据集实例的时代，传统的EXCEL数据管理模式已经无法支持此规模的数据管理，数据库管理（Databse Management）成为比较重要的一个环节，其中包括MySQL、Oracle、Access等数据库管理系统。MySQL（官方发音为/maɪ ˌɛskjuːˈɛl/“My S-Q-L”[1]，但也经常读作/maɪ ˈsiːkwəl/“My Sequel”）原本是一个开放源代码的关系数据库管理系统，原开发者为瑞典的MySQL AB公司，该公司于2008年被昇阳微系统（Sun Microsystems）收购。2009年，甲骨文公司（Oracle）收购昇阳微系统公司，MySQL成为Oracle旗下产品。MySQL由于性能高、成本低、可靠性好，已经成为最流行的开源数据库，因此被广泛地应用在Internet上的中小型网站中。随着MySQL的不断成熟，它也逐渐用于更多大规模网站和应用，比如维基百科、Google和Facebook等网站。非常流行的开源软件组合LAMP中的“M”指的就MySQL。数据分析最重要的工作莫过于提取和管理数据，本例以Dognition公司的数据库为例，简要介绍一下SQL语句的基本语法。

## 一、准备工作
## 1.1加载sql模块
      $ %load_ext sql

## 1.2连接数据库
      $ %sql mysql://studentuser:studentpw@mysqlserver/dognitiondb

## 1,3设置dognitiondb为默认数据库
      $ %sql USE dognitiondb 

## 二、基本查询
## 2.1SQL语句的基本结构
![](http://m.qpic.cn/psb?/V12j1VvP2SOs2p/4H95EA.opPCAN.bWQ5GH3LdrwNwZWOgNgExxj*ol1RQ!/b/dDEBAAAAAAAA&bo=6AT.AgAAAAARFzA!&rf=viewer_4)
## 2.2查询数据库中的表
      $ %sql SHOW tables

## 2.3查询dogs表中含有的列
      $ %sql SHOW columns FROM dogs
      $ %sql SHOW columns FROM dogs FROM dognitiondb
      $ %sql SHOW columns FROM dognitiondb.dogs
      $ %sql DESCRIBE dogs

## 2.4用换行写SQL语句，需要%%sql
      $ %%sql
        SELECT breed
        FROM dogs;

## 2.5为了限制输出行数，使用LIMIT语句
%%sql
SELECT breed
FROM dogs LIMIT 5;        ##输出dogs表breed列前5行记录

%%sql
SELECT breed
FROM dogs LIMIT 10 OFFSET 5;            ##输出dogs表breed列第6行开始的10条记录

## 2.6在同一个表中查询多列
%%sql
SELECT breed,breed_type,breed_group
FROM dogs LIMIT 5,10;

## 查询一个表中的所有列
%%sql
SELECT *
FROM reviews LIMIT 5,10;

查询列的同时对该列数据做数学变换，可直接添加运算符+,-,*,/
%%sql
SELECT median_iti_minutes/60
FROM dogs LIMIT 5,10;

## 查询某个数值型属性符合一定条件的记录
%%sql
SELECT user_guid,free_start_user
FROM users
WHERE free_start_user=1 LIMIT 10;

SELECT dog_guid,weight
FROM dogs
WHERE weight BETWEEN 10 AND 50;

SELECT dog_guid,dog_fixed,dna_tested
FROM dogs
WHERE dog_fixed=1 OR dna_tested=1;

SELECT dog_guid,dog_fixed,dna_tested
FROM dogs
WHERE dog_fixed=1 AND dna_tested!=1;

## 查询某个字符串属性符合一定条件的记录
%%sql
SELECT dog_guid,breed
FROM dogs
WHERE breed=‘golden retriever’;

SELECT dog_guid,breed
FROM dogs
WHERE breed IN(“golden retriever”,”poodle”);

SELECT dog_guid,breed
FROM dogs
WHERE breed LIKE(“s%”);

## 查询某个日期属性符合一定条件的记录
%%sql
SELECT dog_guid,created_at
FROM complete_tests
WHERE DAYNAME(created_at)=“Tuesday ”

SELECT dog_guid,created_at
FROM complete_tests
WHERE DAY(created_at)>15

SELECT dog_guid,created_at
FROM complete_tests
WHERE created_at>’2014-02-04’

SELECT dog_guid,test_name,subcategory_name
FROM complete_tests
WHERE YEAR(created_at)='2014' AND MONTH(created_at)='10'

## 查询某个属性有空值/没有空值的记录
%%sql
SELECT user_guid
FROM users
WHERE free_start_user IS NOT NULL

SELECT user_guid
FROM users
WHERE free_start_user IS NULL

## 查询时更改列、表的名称
%%sql
SELECT dog_guid,created_at AS “time stamp”   #名称中有空格应加引号
FROM complete_tests AS tests

## 查询某一列包含有多少不同值
%%sql
SELECT DISTINCT breed
FROM dogs;

SELECT DISTINCT state, city
FROM users;                           ##查询两个属性有多少种不同的组合

## 查询时按照顺序输出结果
%%sql
SELECT DISTINCT breed
FROM dogs
ORDER BY breed;

SELECT DISTINCT user_guid,state,membership_type
FROM users
WHERE country=“US”
ORDER BY state ASC,membership_type ASC;      ##查询满足country值为US，userID，state，membership_type的不同组合，按照state升序为第一顺序，membership_type升序为第二顺序输出

SELECT DISTINCT user_guid,state,membership_type
FROM users
WHERE country="US" AND state IS NOT NULL AND membership_type IS NOT NULL
ORDER BY membership_type DESC,state ASC LIMIT 50;

## 在jupyter上输出结果
variable_name_of_your_choice = %sql [your full query goes here];       ##将sql查询结果定义为一个变量
the_output_name_you_want.csv('the_output_name_you_want.csv')       ##将该变量形成CSV文件

将breed列开头的‘-’去掉
%%sql
SELECT DISTINCT breed,TRIM(LEADING '-' FROM breed) AS breed_fixed
FROM dogs
ORDER BY breed_fixed

## 查询表中某一列或者所有列的行数
%sql select count(breed) from dogs;
%sql select count(distinct dog_guid) from complete_tests;
%sql select count(exclude) from dogs;

## 查询某一列空值总数
%sql select sum(isnull(exlude)) from dogs;

MAX，AVG，MIN,TIMESTAMPSIFF函数
%%sql
select avg(rating) as avg_rating,min(rating) as min_rating,max(rating) as max_rating
from reviews
where test_name='Memory versus Pointing';

%%sql
select count(timestampdiff(minute,start_time,end_time)) as Duration
from exam_answers
where timestampdiff(minute,start_time,end_time)<0

%%sql
select avg(timestampdiff(minute,start_time,end_time)) as AvgDuration
from exam_answers
where timestampdiff(minute,start_time,end_time)>0

## 分组总结函数 GROUP BY
%%sql
select test_name,avg(rating) as avg_rating
from reviews
group by test_name;

## HAVING语句
%%sql
SELECT state, zip,COUNT(DISTINCT user_guid) AS Num_Guid
FROM users
WHERE country=‘US’
GROUP BY state, zip
HAVING COUNT(DISTINCT user_guid)>5
ORDER BY state ASC,Num_Guid DESC;         ##HAVING后可以加聚合语句，用于分组条件，WHERE后不可以加聚合语句

every non-aggregated field that is listed in the SELECT list must be listed in the GROUP BY list

## 用JOIN语句内连接两个表
%%sql
SELECT d.dog_guid AS DogID, d.user_guid AS UserID, AVG(r.rating) AS AvgRating, 
       COUNT(r.rating) AS NumRatings, d.breed, d.breed_group, d.breed_type
FROM dogs d, reviews r
WHERE d.dog_guid=r.dog_guid AND d.user_guid=r.user_guid
GROUP BY UserID, DogID, d.breed, d.breed_group, d.breed_type
HAVING NumRatings >= 10
ORDER BY AvgRating DESC
LIMIT 200

SELECT d.dog_guid AS DogID, d.user_guid AS UserID, AVG(r.rating) AS AvgRating, COUNT(r.rating) AS NumRatings, d.breed, d.breed_group, d.breed_type
FROM dogs d JOIN reviews r
  ON d.dog_guid=r.dog_guid AND d.user_guid=r.user_guid    ##内连接的传统写法
GROUP BY d.user_guid
HAVING NumRatings > 9
ORDER BY AvgRating DESC
LIMIT 200

%%sql
SELECT d.dog_guid AS DogID, d.user_guid AS UserID, AVG(r.rating) AS AvgRating, 
       COUNT(r.rating) AS NumRatings, d.breed, d.breed_group, d.breed_type
FROM dogs d, reviews r
WHERE d.dog_guid=r.dog_guid AND d.user_guid=r.user_guid
GROUP BY UserID, DogID, d.breed, d.breed_group, d.breed_type
ORDER BY AvgRating DESC

%%sql
SELECT d.user_guid AS UserID,d.dog_guid AS DogID,d.breed,d.breed_type,d.breed_group
FROM dogs d JOIN complete_tests c ON d.dog_guid=c.dog_guid
WHERE test_name='Yawn Warm-up'

%%sql
SELECT r.dog_guid AS rDogID, d.dog_guid AS dDogID, r.user_guid AS rUserID, d.user_guid AS dUserID, AVG(r.rating) AS AvgRating, COUNT(r.rating) AS NumRatings, d.breed, d.breed_group, d.breed_type
FROM dogs d RIGHT JOIN reviews r
  ON d.dog_guid=r.dog_guid AND d.user_guid=r.user_guid
WHERE r.dog_guid IS NOT NULL
GROUP BY r.dog_guid
HAVING NumRatings >= 10
ORDER BY AvgRating DESC;

%%sql
SELECT d.dog_guid AS dDogID,c.dog_guid AS cDogID,d.user_guid AS dUserID,c.user_guid AS cUerID,COUNT(test_name) AS NumTests
FROM dogs d LEFT JOIN complete_tests c ON d.dog_guid=c.dog_guid
GROUP BY d.dog_guid

%%sql
SELECT u.user_guid AS uUserID, d.user_guid AS dUserID, d.dog_guid AS dDogID,
d.breed, count(*) AS numrows FROM users u LEFT JOIN dogs d
ON u.user_guid=d.user_guid GROUP BY u.user_guid ORDER BY numrows DESC;

## 子查询嵌套
%%sql
SELECT * 
FROM exam_answers
WHERE TIMESTAMPDIFF(minute,start_time,end_time)>
(SELECT AVG(TIMESTAMPDIFF(minute,start_time,end_time)) AS AvgDuration
 FROM exam_answers
 WHERE test_name='Yawn Warm-Up' AND TIMESTAMPDIFF(minute,start_time,end_time)>0);

%%sql
SELECT COUNT(DISTINCT dog_guid)
FROM dogs
WHERE breed_group NOT IN ('Working','Sporting','Herding')

SELECT DISTINCT u.user_guid AS uUserID
FROM users u
WHERE EXISTS (SELECT *
              FROM dogs d 
              WHERE u.user_guid =d.user_guid);

%%sql
SELECT  u.user_guid
FROM users u
WHERE NOT EXISTS (SELECT * FROM dogs d WHERE u.user_guid=d.user_guid)  ##选出users中存在但dogs中不存在的所有user_guid

%%sql
SELECT DistinctUUsersID.user_guid AS uUserID, d.user_guid AS dUserID, count(*) AS numrows
FROM (SELECT DISTINCT u.user_guid 
      FROM users u) AS DistinctUUsersID   ##必须给derived table 起一个临时名字          
LEFT JOIN dogs d
   ON DistinctUUsersID.user_guid=d.user_guid
GROUP BY DistinctUUsersID.user_guid
ORDER BY numrows DESC

%%sql
SELECT d.user_guid
FROM dogs d
WHERE NOT EXISTS(SELECT * FROM users u WHERE u.user_guid=d.user_guid)

IF语句
%%sql
SELECT cleaned_users.user_guid as UserID,
       IF(cleaned_users.first_account<'2014-06-01','early_user','late_user') AS user_type
FROM (SELECT user_guid, MIN(created_at) AS first_account 
      FROM users
      GROUP BY user_guid) AS cleaned_users

%%sql
SELECT IF(a.country='US','In US','Out of US') AS UserLocation,COUNT(a.user_guid) AS numguids
FROM (SELECT distinct user_guid,country
from users
where user_guid IS NOT NULL and country IS NOT NULL) AS a
GROUP BY UserLocation;

## IF语句的嵌套
%%sql
SELECT IF(cleaned_users.country='US','In US', 
          IF(cleaned_users.country='N/A','Not Applicable','Outside US')) AS US_user, 
      count(cleaned_users.user_guid)   
FROM (SELECT DISTINCT user_guid, country 
      FROM users
      WHERE country IS NOT NULL) AS cleaned_users
GROUP BY US_user

## CASE语句
There are a couple of things to know about CASE expressions:
* Make sure to include the word END at the end of the expression
* CASE expressions do not require parentheses
* ELSE expressions are optional
* If an ELSE expression is omitted, NULL values will be outputted for all rows that do not meet any of the conditions stated explicitly in the expression
* CASE expressions can be used anywhere in a SQL statement, including in GROUP BY, HAVING, and ORDER BY clauses or the SELECT column list.
%%sql
SELECT CASE WHEN cleaned_users.country="US" THEN "In US"
                         WHEN cleaned_users.country="N/A" THEN "Not Applicable"
                         ELSE "Outside US"
                         END AS US_user, 
      count(cleaned_users.user_guid)   
FROM (SELECT DISTINCT user_guid, country 
      FROM users
      WHERE country IS NOT NULL) AS cleaned_users
GROUP BY US_user

上例等价于
%%sql
SELECT CASE cleaned_users.country
            WHEN "US" THEN "In US"
            WHEN "N/A" THEN "Not Applicable"
            ELSE "Outside US"
            END AS US_user, 
      count(cleaned_users.user_guid)   
FROM (SELECT DISTINCT user_guid, country 
      FROM users
      WHERE country IS NOT NULL) AS cleaned_users
GROUP BY US_user

%%sql
SELECT dog_guid,dog_fixed,
    CASE dog_fixed
      WHEN '1' THEN 'neutered'
        WHEN '0' THEN 'not neutered'
    END AS neutered
FROM dogs LIMIT 200

逻辑语句的执行顺序 1.NOT 2.AND 3.OR
